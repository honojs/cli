import type { Command } from 'commander'
import { writeFileSync } from 'node:fs'
import * as esbuild from 'esbuild'
import type { Hono } from 'hono'
import { RegExpRouter } from 'hono/router/reg-exp-router'
import { SmartRouter } from 'hono/router/smart-router'
import { TrieRouter } from 'hono/router/trie-router'
import { existsSync, realpathSync } from 'node:fs'
import { resolve, extname, dirname } from 'node:path'
import { pathToFileURL } from 'node:url'

export function buildCommand(program: Command) {
  program
    .command('build')
    .description('Build optimized preset')
    .argument('[entry]', 'entry file', './src/index.ts')
    .option('-o, --outfile [outfile]', 'output file')
    .action(async (entry: string, options: { outfile?: string }) => {
      const ext = extname(entry)
      const appPath = resolve(process.cwd(), entry)
      const outfile = options.outfile
        ? resolve(process.cwd(), options.outfile)
        : resolve(dirname(appPath), `hono-custom-preset${ext}`)

      if (!existsSync(appPath)) {
        throw new Error(`Entry file ${entry} does not exist`)
      }

      let app: Hono

      const appFilePath = realpathSync(appPath)
      // TypeScript/JSX files need transformation and bundling
      if (['.ts', '.tsx', '.jsx'].includes(ext)) {
        // Use build API to resolve imports and bundle
        const result = await esbuild.build({
          entryPoints: [appFilePath],
          bundle: true,
          write: false,
          format: 'esm',
          target: 'node20',
          jsx: 'automatic',
          jsxImportSource: 'hono/jsx',
          platform: 'node',
          external: ['@hono/node-server'], // Keep server external
          sourcemap: 'inline',
        })

        // Execute the bundled code using data URL
        const code = result.outputFiles[0].text
        const dataUrl = `data:text/javascript;base64,${Buffer.from(code).toString('base64')}`
        const module = await import(dataUrl)
        app = module.default
      } else {
        // Regular JS files can be imported directly
        const module = await import(pathToFileURL(appFilePath).href)
        app = module.default
      }

      const smartRouter = new SmartRouter({
        routers: [new RegExpRouter(), new TrieRouter()],
      })
      app.routes.forEach(({ method, path }) => {
        smartRouter.add(path, method, true)
      })
      smartRouter.match('/', 'GET')

      if (['.ts', '.tsx'].includes(ext)) {
        writeFileSync(
          outfile,
          `
// This file is generated by \`hono build\`
import { HonoBase } from 'hono/hono-base'
import type { HonoOptions } from 'hono/hono-base'
import { RegExpRouter } from 'hono/router/reg-exp-router'
import { SmartRouter } from 'hono/router/smart-router'
import { TrieRouter } from 'hono/router/trie-router'
import type { BlankEnv, BlankSchema, Env, Schema } from 'hono/types'

export class Hono<
  E extends Env = BlankEnv,
  S extends Schema = BlankSchema,
  BasePath extends string = '/'
> extends HonoBase<E, S, BasePath> {
  constructor(options: HonoOptions<E> = {}) {
    super(options)
    this.router = new ${smartRouter.activeRouter.constructor.name}()
  }
}
`
        )
      } else {
        writeFileSync(
          outfile,
          `
// This file is generated by \`hono build\`
import { HonoBase } from 'hono/hono-base'
import { RegExpRouter } from 'hono/router/reg-exp-router'
import { SmartRouter } from 'hono/router/smart-router'
import { TrieRouter } from 'hono/router/trie-router'

export class Hono extends HonoBase {
  constructor(options = {}) {
    super(options)
    this.router = new ${smartRouter.activeRouter.constructor.name}()
  }
}
`
        )
      }
    })
}
